<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><title>Личные заметки и всякая всячина - Кросс-компиляция Rust для raspberry pi</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="stylesheet" href="/style/global.css"><link rel="stylesheet" href="/style/prism-vsc-dark-plus.css"><link rel="stylesheet" href="/_astro/common-bMouB.css" type="text/css"></head><body class="main-grid"><header class="main-grid__header astro-HaDR30LO"><a href="/" class="moto-link astro-HaDR30LO"><h1 class="moto astro-HaDR30LO">Личные заметки и всякая всячина.</h1></a></header><main class="main-grid__main astro-HaDR30LO"><h2 class="astro-T9ouf1IY">Кросс-компиляция Rust для raspberry pi</h2><nav class="breadcrumbs astro-Iv2DiwOJ"><a href="/" class="breadcrubmbs-link astro-N3k3AXB7">Главная страница</a><a href="/programming/" class="breadcrubmbs-link astro-N3k3AXB7">Программирование</a><span class="breadcrumbs__current astro-Iv2DiwOJ">Кросс-компиляция Rust для raspberry pi</span></nav><article class="md-content astro-T9ouf1IY"><p>В этой статье описан процесс кросскомпиляции из под Windows на raspberry pi/raspbian как он был на 2-17 год.
Вероятно часть с OpenSSL уже поменялась, но можно использовать статью как основну для процесса.</p><p>Кросскомпиляция для pi из под винды не представляет сложности, пока вам не понадобится openssl.</p><p>Для начала, настройка кросскомпиляции в самом cargo. Для начала сам тулчейн rust'а:</p><pre class=" language-html"><code class="language-html">&gt; rustup target add armv7-unknown-linux-gnueabihf
</code></pre><p>Также нужно скачать и установить arm-toolchain <a href="http://gnutoolchains.com/raspberry/">отсюда</a></p><p>Дальше создаём папку и файл .cargo/config со следующим содержимым:</p><pre class=" language-toml"><code class="language-toml"><span class="token punctuation">[</span><span class="token table class-name">build</span><span class="token punctuation">]</span>
<span class="token key property">target</span> <span class="token punctuation">=</span> <span class="token string">"armv7-unknown-linux-gnueabihf"</span>

<span class="token punctuation">[</span><span class="token table class-name">target.armv7-unknown-linux-gnueabihf</span><span class="token punctuation">]</span>
<span class="token key property">linker</span> <span class="token punctuation">=</span> <span class="token string">"arm-linux-gnueabihf-gcc"</span>
</code></pre><p>Поле target раздела build задаёт платформу по умолчанию, можно не указывать и запускать сборку руками при желании:</p><p><code>cargo build --target=arm-unknown-linux-gnueabihf</code></p><p>Если openssl не нужен, то этого достаточно. В противном случае у нас будет проблема -- линкер не сможет найти бибилиотеку (если она у вас не кросскомпилированна до этого). Чтобы не кросскомпилировать самостоятельно openssl можно сделать хитррость -- добавить в зависимости:</p><p><code>openssl = { version = "0.10", features = ["vendored"] }</code></p><p>Таким образом openssl будет скомпилирован внутри cargo и прилинкован статически к проекту.
Есть одно но -- чтобы его собрать все равно надо настроить некий инструментарий.
Потребуется perl (c dmake), т.к. openssl использует самописную систему конфигурации. При этом обычный perl для винды
(вроде ActivePerl) нам не подходит, т.к. он использует слэши не туда куда положено. Нужно ставить perl конкретно из
msys2, так что предварительно скачиваем и устанавливаем его согласно инструкции или же используем chocolatey,
если доступен. После этого нам ещё нужен его dmake:</p><pre class=" language-shell"><code class="language-shell"><span class="token operator">&gt;</span> choco <span class="token function">install</span> msys2
</code></pre><p>И в консоли msys</p><pre class=" language-shell"><code class="language-shell"><span class="token operator">&gt;</span> pacman -S perl
</code></pre><p>Перед самой компиляцией, необходимо дополнительно выставить переменные среды:</p><pre class=" language-shell"><code class="language-shell"><span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> <span class="token assign-left variable">PERL5LIB</span><span class="token operator">=</span>/C/tools/msys64/usr/share/perl5/core_perl <span class="token comment"># чтобы perl поймал либы из под винды</span>
<span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> <span class="token assign-left variable">CARGO_TARGET_ARM_UNKNOWN_LINUX_GNUEABIHF_LINKER</span><span class="token operator">=</span>arm-linux-gnueabihf-gcc
<span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> <span class="token assign-left variable">CC</span><span class="token operator">=</span>arm-linux-gnueabihf-gcc
<span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> CC_armv7-unknown-linux-gnueabihf<span class="token operator">=</span>arm-linux-gnueabihf-gcc
</code></pre><p>Кстати, ещё неплохо бы было убедиться, что PATH ничего не перебивает наши исполняемые файлы dmake, сс и т.п.</p><pre class=" language-shell"><code class="language-shell"><span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span>C:SysGCC
aspberryin<span class="token punctuation">;</span>%<span class="token environment constant">PATH</span>%
</code></pre><h3 id="ultima-ratio">Ultima Ratio</h3><p>Вроде бы всё это в теории верно, но у меня компиляция вываливается на make depend. Тогда компилируем бибилотеку физически на pi (делаем ./config и make, без make install, разумеется требуется установленный пакет build-essential), скачиваем, подкладываем внутрь C:\SysGCC\raspberry и выставляем переменные среды, чтобы cargo использовал её:</p><pre class=" language-shell"><code class="language-shell"><span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> <span class="token assign-left variable">OPENSSL_LIB_DIR</span><span class="token operator">=</span>C:SysGCC
aspberryopenssl-1.1.1a
<span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> <span class="token assign-left variable">OPENSSL_INCLUDE_DIR</span><span class="token operator">=</span>C:SysGCC
aspberryopenssl-1.1.1ainclude
<span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> <span class="token assign-left variable">OPENSSL_STATIC</span><span class="token operator">=</span><span class="token number">1</span>
</code></pre></article></main><footer class="main-grid__footer astro-HaDR30LO"><a href="https://github.com/religiosa1/religiosa1.github.io" class="github-link astro-HaDR30LO">
      Исходный код
    </a></footer></body></html>