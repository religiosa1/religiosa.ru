<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><title>Личные заметки и всякая всячина - Работа с медиа-файлами</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="stylesheet" href="/style/global.css"><link rel="stylesheet" href="/style/prism-vsc-dark-plus.css"><link rel="stylesheet" href="/_astro/common-bMouB.css" type="text/css"></head><body class="main-grid"><header class="main-grid__header astro-HaDR30LO"><a href="/" class="moto-link astro-HaDR30LO"><h1 class="moto astro-HaDR30LO">Личные заметки и всякая всячина.</h1></a></header><main class="main-grid__main astro-HaDR30LO"><h2 class="astro-T9ouf1IY">Работа с медиа-файлами</h2><nav class="breadcrumbs astro-Iv2DiwOJ"><a href="/" class="breadcrubmbs-link astro-N3k3AXB7">Главная страница</a><a href="/programming/" class="breadcrubmbs-link astro-N3k3AXB7">Программирование</a><span class="breadcrumbs__current astro-Iv2DiwOJ">Работа с медиа-файлами</span></nav><article class="md-content astro-T9ouf1IY"><p>Рекомендованные программы для оптимизаций или преобразования различных форматов медиа-файлов для веба. Все команды даны в синтаскисе CMD, но работают так же и под линуксом.</p><h2 id="содержание">Содержание</h2><ul><li><p><a href="#%D0%B8%D0%B7%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F">Изображения</a></p><ul><li><a href="#%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F-png">Оптимизация png</a></li><li><a href="#%D1%81%D0%B1%D0%BE%D1%80%D0%BA%D0%B0-png-%D1%81%D0%B5%D0%BA%D0%B2%D0%B5%D0%BD%D1%86%D0%B8%D0%B9">Сборка png-секвенций</a></li><li><a href="#%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F-jpg%D0%BE%D0%B2">Оптимизация JPG'ов</a></li><li><a href="#%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F-svg">Оптимизация SVG</a></li><li><a href="#%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5%D1%83%D0%B6%D0%B0%D1%82%D0%B8%D0%B5-webp">Создание/ужатие WebP</a></li></ul></li><li><p><a href="#%D0%BA%D0%BE%D0%B4%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B0-%D0%B2%D0%B8%D0%B4%D0%B5%D0%BE">Кодировка видео</a></p><ul><li><a href="#%D0%B3%D0%B5%D0%BD%D0%B5%D1%80%D0%B0%D1%86%D0%B8%D1%8F-%D1%82%D0%B0%D0%BC%D0%B1%D0%BD%D0%B5%D0%B9%D0%BB%D0%BE%D0%B2">Генерация тамбнейлов</a></li><li><a href="#%D0%BA%D0%BE%D0%B4%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B0-webmvp9-%D0%B2-%D0%B4%D0%B2%D0%B0-%D0%BF%D1%80%D0%BE%D1%85%D0%BE%D0%B4%D0%B0">Кодировка webm/vp9 в два прохода</a></li><li><a href="#%D0%BA%D0%BE%D0%B4%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B0-mp4h264-%D0%B2-%D0%B4%D0%B2%D0%B0-%D0%BF%D1%80%D0%BE%D1%85%D0%BE%D0%B4%D0%B0">Кодировка mp4/h264 в два прохода:</a></li></ul></li><li><p><a href="#%D0%BF%D1%80%D0%B5%D0%BE%D0%B1%D1%80%D0%B0%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5-%D1%88%D1%80%D0%B8%D1%84%D1%82%D0%BE%D0%B2">Преобразование шрифтов</a></p></li></ul><h2 id="изображения">Изображения</h2><h3 id="оптимизация-png">Оптимизация png</h3><p>Наилучшие результаты (по уровню сжатия с потерями) выдаёт <a href="https://pngquant.org/">pngquant</a>.</p><h3 id="сборка-png-секвенций">Сборка png-секвенций</h3><p>Несмотря на то, что в imagemagick'е есть специальная команда montage, простые анимированные секвенций легче собирать при помощи</p><pre class=" language-shell"><code class="language-shell">$ convert .*.png +append sprite.png
</code></pre><h3 id="оптимизация-jpgов">Оптимизация JPG'ов</h3><pre class=" language-shell"><code class="language-shell">$ jpegoptim --strip-all --all-progressive -tm85 *.jpg
</code></pre><h3 id="оптимизация-svg">Оптимизация SVG</h3><p>Если необходимо ужать SVG файл, или исправить проблему с дубликатами в ID при инлайне, то можно воспользоваться пакетом svgo.</p><pre class=" language-shell"><code class="language-shell">$ svgo --enable<span class="token operator">=</span>prefixIds --disable<span class="token operator">=</span>removeViewBox some.svg
</code></pre><p>prefixIds имеет параметр prefixClassNames, только непонтяно как его вызвать через консоль. Без viewBox инлайны не скейлятся по нормальному, так что эту опцию отключаем.</p><h3 id="созданиеужатие-webp">Создание/ужатие WebP</h3><p>Референсная имплементация от Google cwebp/dwebp. Ссылка на репозиторий с бинарниками доступна в их <a href="https://developers.google.com/speed/webp/docs/precompiled">документации</a></p><h2 id="кодировка-видео">Кодировка видео</h2><h3 id="генерация-тамбнейлов">Генерация тамбнейлов</h3><p>Превью можно сгенерировать командой (не забыв указать нужный размер у scale):</p><pre class=" language-shell"><code class="language-shell">$ <span class="token keyword">for</span> %f <span class="token keyword">in</span> <span class="token punctuation">(</span>*.mp4<span class="token punctuation">)</span> <span class="token keyword">do</span> ffmpeg -i <span class="token string">"%f"</span> -vf <span class="token string">"thumbnail,scale=1920:1012"</span> -vframes <span class="token number">1</span> -y <span class="token string">"out/%~nf.jpg"</span>
</code></pre><h3 id="кодировка-webmvp9-в-два-прохода">Кодировка webm/vp9 в два прохода</h3><p>Без звука:</p><pre class=" language-shell"><code class="language-shell">$ <span class="token function">mkdir</span> out
$ <span class="token keyword">for</span> %f <span class="token keyword">in</span> <span class="token punctuation">(</span>*.mp4<span class="token punctuation">)</span> <span class="token keyword">do</span> ffmpeg -i <span class="token string">"%f"</span> -vf <span class="token assign-left variable">scale</span><span class="token operator">=</span><span class="token string">"1920:-1"</span> -c:v libvpx-vp9 -b:v 1M -an -pass <span class="token number">1</span> -y -f webm NUL <span class="token operator">&amp;&amp;</span> ffmpeg -i <span class="token string">"%f"</span> -vf <span class="token assign-left variable">scale</span><span class="token operator">=</span><span class="token string">"1920:-1"</span> -c:v libvpx-vp9 -b:v 1M -an -pass <span class="token number">2</span> -y <span class="token string">"out/%~nf.webm"</span>
</code></pre><p><a href="https://trac.ffmpeg.org/wiki/Encode/VP9#variableb">Документация</a></p><h3 id="кодировка-mp4h264-в-два-прохода">Кодировка mp4/h264 в два прохода:</h3><p>Без звука:</p><pre class=" language-shell"><code class="language-shell"><span class="token keyword">for</span> %f <span class="token keyword">in</span> <span class="token punctuation">(</span>*.mp4<span class="token punctuation">)</span> <span class="token keyword">do</span> ffmpeg -y -i <span class="token string">"%f"</span> -vf <span class="token assign-left variable">scale</span><span class="token operator">=</span><span class="token string">"1920:1012"</span> -c:v libx264 -b:v 1300k -pass <span class="token number">1</span> -an -f mp4 -y NUL <span class="token operator">&amp;&amp;</span> ffmpeg -i <span class="token string">"%f"</span> -vf <span class="token assign-left variable">scale</span><span class="token operator">=</span><span class="token string">"1920:1012"</span> -c:v libx264 -b:v 1300k -pass <span class="token number">2</span> -an -y <span class="token string">"out/%~nf.mp4"</span>
</code></pre><p><a href="https://trac.ffmpeg.org/wiki/Encode/H.264#twopass">Документация</a></p><h2 id="преобразование-шрифтов">Преобразование шрифтов</h2><p>Для компресии шрифтов в woff2 лучше использовать <a href="https://github.com/google/woff2">референсную имплементацию</a>
от Google. Бинарников там нет, сборка под windows x64 лежит <a href="/media/woff2_1.02.zip">тут</a></p></article></main><footer class="main-grid__footer astro-HaDR30LO"><a href="https://github.com/religiosa1/religiosa1.github.io" class="github-link astro-HaDR30LO">
      Исходный код
    </a></footer></body></html>